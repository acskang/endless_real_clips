{% load static %}
<!-- JavaScript ë¡œë“œ -->

<!-- Django í…œí”Œë¦¿ ë°ì´í„° ì „ë‹¬ -->
<script>
    // ì‹¤ì œ Django views.pyì—ì„œ ì „ë‹¬ëœ ë°ì´í„°
    window.djangoData = {
        csrf_token: '{{ csrf_token }}',
        
        // URL íŒ¨í„´ (API ë¯¸êµ¬í˜„ ì‹œ ì„ì‹œ ì²˜ë¦¬)
        urls: {
            {% comment %}
            // APIê°€ êµ¬í˜„ë˜ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”:
            popular_searches: '{% url "phrase:popular_searches_api" %}',
            statistics: '{% url "phrase:statistics_api" %}',
            bulk_translate: '{% url "phrase:bulk_translate_dialogues" %}'
              {% endcomment %}
            popular_searches: '/api/search/',  // ì„ì‹œë¡œ ê¸°ì¡´ API ì‚¬ìš©
            statistics: '/api/schema/',  // ì„ì‹œë¡œ ê¸°ì¡´ API ì‚¬ìš©  
            bulk_translate: ''  // ë¯¸êµ¬í˜„
        },
        
        // í˜„ì¬ ê²€ìƒ‰ ì •ë³´
        search: {
            query: "{{ message|escapejs }}",
            translated: "{{ translated_message|escapejs }}",
            phrase: "{{ search_used|escapejs }}",
            hasResults: {{ movies|yesno:"true,false" }},
            totalResults: {{ total_results|default:0 }},
            fromCache: {{ from_cache|yesno:"true,false" }},
            source: "{{ source|default:'database' }}"
        },
        
        // ì„¤ì •
        settings: {
            maxSearchLength: 500,  // RequestTable.request_phrase max_length
            minSearchLength: 2,
            debounceDelay: 300,
            cacheTimeout: 600000
        }
    };

    // ===== ğŸ¬ ë¹„ë””ì˜¤ ëª¨ë‹¬ í•¨ìˆ˜ (ì¦‰ì‹œ ì •ì˜) =====
    // ğŸ”§ ì¦‰ì‹œ ì •ì˜í•˜ì—¬ HTMLì—ì„œ ë°”ë¡œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ í•¨
    window.openVideoModal = function(videoUrl, title, year, country, textEn, textKo) {
        console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ ëª¨ë‹¬ í•¨ìˆ˜ ì‹œì‘:', { videoUrl, title, year, country, textEn, textKo });
        
        try {
            // ëª¨ë‹¬ ì œëª© ì„¤ì •
            console.log('ğŸ¬ [DEBUG] 1. ëª¨ë‹¬ ì œëª© ì„¤ì • ì‹œì‘');
            const modalTitle = document.getElementById('modal-title');
            console.log('ğŸ¬ [DEBUG] modalTitle ìš”ì†Œ:', modalTitle);
            if (modalTitle) {
                modalTitle.textContent = `${title} (${year}, ${country})`;
                console.log('ğŸ¬ [DEBUG] ëª¨ë‹¬ ì œëª© ì„¤ì • ì™„ë£Œ:', modalTitle.textContent);
            }

            // ì˜ì–´ ëŒ€ì‚¬ ì„¤ì •
            console.log('ğŸ¬ [DEBUG] 2. ì˜ì–´ ëŒ€ì‚¬ ì„¤ì • ì‹œì‘');
            const modalTextEn = document.getElementById('modal-text-en');
            console.log('ğŸ¬ [DEBUG] modalTextEn ìš”ì†Œ:', modalTextEn);
            if (modalTextEn) {
                modalTextEn.textContent = `"${textEn}"`;
                console.log('ğŸ¬ [DEBUG] ì˜ì–´ ëŒ€ì‚¬ ì„¤ì • ì™„ë£Œ');
            }

            // í•œê¸€ ë²ˆì—­ ì„¤ì •
            console.log('ğŸ¬ [DEBUG] 3. í•œê¸€ ë²ˆì—­ ì„¤ì • ì‹œì‘');
            const modalTextKo = document.getElementById('modal-text-ko');
            console.log('ğŸ¬ [DEBUG] modalTextKo ìš”ì†Œ:', modalTextKo);
            if (modalTextKo) {
                if (textKo && textKo.trim()) {
                    modalTextKo.innerHTML = `ğŸ’¾ "${textKo}"`;
                    console.log('ğŸ¬ [DEBUG] í•œê¸€ ë²ˆì—­ ì„¤ì • ì™„ë£Œ (ë²ˆì—­ë¨)');
                } else {
                    modalTextKo.innerHTML = '<span class="text-muted">ë²ˆì—­ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>';
                    console.log('ğŸ¬ [DEBUG] í•œê¸€ ë²ˆì—­ ì„¤ì • ì™„ë£Œ (ë¯¸ë²ˆì—­)');
                }
            }

            // ğŸ”§ ë¹„ë””ì˜¤ ìš”ì†Œ ì²˜ë¦¬
            console.log('ğŸ¬ [DEBUG] 4. ë¹„ë””ì˜¤ ìš”ì†Œ ì°¾ê¸° ì‹œì‘');
            const videoLoading = document.getElementById('video-loading');
            const modalVideo = document.getElementById('modal-video');
            const videoError = document.getElementById('video-error');
            
            console.log('ğŸ¬ [DEBUG] DOM ìš”ì†Œ í™•ì¸:', {
                videoLoading: !!videoLoading,
                modalVideo: !!modalVideo,
                videoError: !!videoError,
                videoExists: !!modalVideo,
                videoUrl: videoUrl,
                videoUrlLength: videoUrl ? videoUrl.length : 0
            });

            // ì´ˆê¸° ìƒíƒœ
            console.log('ğŸ¬ [DEBUG] 5. ì´ˆê¸° ìƒíƒœ ì„¤ì • ì‹œì‘');
            if (videoLoading) {
                videoLoading.classList.remove('d-none');
                console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ ë¡œë”© í‘œì‹œë¨');
            } else {
                console.warn('ğŸ¬ [DEBUG] âš ï¸ videoLoading ìš”ì†Œ ì—†ìŒ');
            }
            
            if (modalVideo) {
                modalVideo.classList.add('d-none');
                console.log('ğŸ¬ [DEBUG] ëª¨ë‹¬ ë¹„ë””ì˜¤ ìˆ¨ê¹€');
            } else {
                console.error('ğŸ¬ [DEBUG] âŒ modalVideo ìš”ì†Œ ì—†ìŒ!');
            }
            
            if (videoError) {
                videoError.classList.add('d-none');
                console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ ì—ëŸ¬ ìˆ¨ê¹€');
            } else {
                console.warn('ğŸ¬ [DEBUG] âš ï¸ videoError ìš”ì†Œ ì—†ìŒ');
            }

            console.log('ğŸ¬ [DEBUG] 6. URL ë° ë¹„ë””ì˜¤ ìš”ì†Œ ìœ íš¨ì„± ê²€ì‚¬');
            console.log('ğŸ¬ [DEBUG] ì¡°ê±´ í™•ì¸:', {
                'videoUrl exists': !!videoUrl,
                'videoUrl trimmed': videoUrl && videoUrl.trim(),
                'modalVideo exists': !!modalVideo,
                'all conditions': videoUrl && videoUrl.trim() && modalVideo
            });

            if (videoUrl && videoUrl.trim() && modalVideo) {
                console.log('ğŸ¬ [DEBUG] âœ… ëª¨ë“  ì¡°ê±´ í†µê³¼ - ë¹„ë””ì˜¤ ì„¤ì • ì‹œì‘');
                
                // ğŸ”§ ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
                console.log('ğŸ¬ [DEBUG] 7. ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • ì‹œì‘');
                const videoSource = document.getElementById('video-source');
                console.log('ğŸ¬ [DEBUG] videoSource ìš”ì†Œ:', videoSource);
                if (videoSource) {
                    videoSource.src = videoUrl;
                    console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • ì™„ë£Œ:', videoSource.src);
                } else {
                    console.error('ğŸ¬ [DEBUG] âŒ videoSource ìš”ì†Œ ì—†ìŒ!');
                }

                // ğŸ”§ ëª¨ë“  ë¹„ë””ì˜¤ ì†ì„±ì„ JavaScriptì—ì„œë§Œ ì„¤ì •
                console.log('ğŸ¬ [DEBUG] 8. ë¹„ë””ì˜¤ ì†ì„± ì œê±° ì‹œì‘');
                modalVideo.removeAttribute('autoplay');  
                modalVideo.removeAttribute('muted');     
                modalVideo.removeAttribute('loop');       
                modalVideo.removeAttribute('controls');   
                modalVideo.removeAttribute('preload'); 
                console.log('ğŸ¬ [DEBUG] HTML ì†ì„± ì œê±° ì™„ë£Œ');
                
                // âœ… ìµœì¢… ì†ì„± ì„¤ì •: ìë™ì¬ìƒ ë¹„í™œì„±í™”, ìŒì†Œê±° í•´ì œ
                console.log('ğŸ¬ [DEBUG] 9. JavaScript ì†ì„± ì„¤ì • ì‹œì‘');
                modalVideo.controls = true;        // ì»¨íŠ¸ë¡¤ í‘œì‹œ
                modalVideo.loop = true;           // ë¬´í•œ ë£¨í”„
                modalVideo.autoplay = false;      // ğŸ”§ ìë™ì¬ìƒ ë¹„í™œì„±í™”!
                modalVideo.muted = false;         // ğŸ”§ ìŒì†Œê±° í•´ì œ!
                modalVideo.volume = 1.0;          // ë³¼ë¥¨ ìµœëŒ€
                modalVideo.preload = 'metadata';  // ë©”íƒ€ë°ì´í„°ë§Œ ë¯¸ë¦¬ ë¡œë“œ
                console.log('ğŸ¬ [DEBUG] JavaScript ì†ì„± ì„¤ì • ì™„ë£Œ');
                
                console.log('ğŸ¬ [DEBUG] 10. ìµœì¢… ë¹„ë””ì˜¤ ì†ì„± í™•ì¸:', {
                    autoplay: modalVideo.autoplay,           // falseì—¬ì•¼ í•¨
                    muted: modalVideo.muted,                 // falseì—¬ì•¼ í•¨
                    volume: modalVideo.volume,               // 1.0ì´ì–´ì•¼ í•¨
                    loop: modalVideo.loop,                   // true
                    controls: modalVideo.controls,           // true
                    hasAutoplayAttr: modalVideo.hasAttribute('autoplay'),  // falseì—¬ì•¼ í•¨
                    hasMutedAttr: modalVideo.hasAttribute('muted'),        // falseì—¬ì•¼ í•¨
                    src: videoSource ? videoSource.src : 'No source',
                    readyState: modalVideo.readyState,
                    networkState: modalVideo.networkState
                });
                
                // ğŸ”§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í•œ ë²ˆë§Œ ì‹¤í–‰)
                console.log('ğŸ¬ [DEBUG] 11. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
                modalVideo.onloadeddata = function() {
                    console.log('ğŸ¬ [DEBUG] ğŸ“¹ loadeddata ì´ë²¤íŠ¸ ë°œìƒ - ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    console.log('ğŸ¬ [DEBUG] ë¡œë“œ í›„ ìµœì¢… ìƒíƒœ:', {
                        autoplay: this.autoplay,
                        muted: this.muted,
                        volume: this.volume,
                        loop: this.loop,
                        readyState: this.readyState,
                        paused: this.paused,
                        currentTime: this.currentTime,
                        duration: this.duration
                    });
                    
                    console.log('ğŸ¬ [DEBUG] ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸° ì‹œì‘');
                    if (videoLoading) {
                        videoLoading.classList.add('d-none');
                        console.log('ğŸ¬ [DEBUG] ë¡œë”© í™”ë©´ ìˆ¨ê¹€ ì™„ë£Œ');
                    }
                    
                    console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ í‘œì‹œí•˜ê¸° ì‹œì‘');
                    modalVideo.classList.remove('d-none');
                    console.log('ğŸ¬ [DEBUG] ë¹„ë””ì˜¤ í‘œì‹œ ì™„ë£Œ');
                    
                    console.log('ğŸ¬ [DEBUG] â–¶ï¸ ì‚¬ìš©ìê°€ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì¬ìƒë©ë‹ˆë‹¤ (ğŸ”Š ì†Œë¦¬ í¬í•¨)');
                    
                    // ğŸ”§ ì¶”ê°€ í™•ì¸: ìë™ì¬ìƒì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ëŠ”ì§€ ì²´í¬
                    if (!this.paused) {
                        console.warn('ğŸ¬ [DEBUG] âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ìë™ì¬ìƒ ê°ì§€ - ì¼ì‹œì •ì§€');
                        this.pause();
                        this.currentTime = 0;
                    } else {
                        console.log('ğŸ¬ [DEBUG] âœ… ë¹„ë””ì˜¤ê°€ ì˜¬ë°”ë¥´ê²Œ ì¼ì‹œì •ì§€ ìƒíƒœ');
                    }
                };
                
                modalVideo.onerror = function(e) {
                    console.error('ğŸ¬ [DEBUG] âŒ error ì´ë²¤íŠ¸ ë°œìƒ - ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', e);
                    console.error('ğŸ¬ [DEBUG] ì—ëŸ¬ ìƒì„¸:', {
                        error: this.error,
                        networkState: this.networkState,
                        readyState: this.readyState
                    });
                    
                    if (videoLoading) {
                        videoLoading.classList.add('d-none');
                        console.log('ğŸ¬ [DEBUG] ë¡œë”© í™”ë©´ ìˆ¨ê¹€ (ì—ëŸ¬)');
                    }
                    if (videoError) {
                        videoError.classList.remove('d-none');
                        console.log('ğŸ¬ [DEBUG] ì—ëŸ¬ í™”ë©´ í‘œì‹œ');
                        
                        const errorMessage = document.getElementById('error-message');
                        const errorUrl = document.getElementById('error-url');
                        if (errorMessage) errorMessage.textContent = 'ë¹„ë””ì˜¤ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        if (errorUrl) errorUrl.textContent = videoUrl;
                    }
                };
                
                modalVideo.onloadstart = function() {
                    console.log('ğŸ¬ [DEBUG] loadstart ì´ë²¤íŠ¸ - ë¡œë“œ ì‹œì‘ë¨');
                };
                
                modalVideo.onprogress = function() {
                    console.log('ğŸ¬ [DEBUG] progress ì´ë²¤íŠ¸ - ë¡œë“œ ì§„í–‰ ì¤‘');
                };
                
                modalVideo.oncanplay = function() {
                    console.log('ğŸ¬ [DEBUG] canplay ì´ë²¤íŠ¸ - ì¬ìƒ ê°€ëŠ¥í•œ ìƒíƒœ');
                };
                
                // ğŸ”§ ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
                console.log('ğŸ¬ [DEBUG] 12. ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘');
                modalVideo.load();
                console.log('ğŸ¬ [DEBUG] modalVideo.load() í˜¸ì¶œ ì™„ë£Œ');
                
            } else {
                console.error('ğŸ¬ [DEBUG] âŒ ì¡°ê±´ ì‹¤íŒ¨:', {
                    videoUrl: videoUrl,
                    'videoUrl && videoUrl.trim()': videoUrl && videoUrl.trim(),
                    modalVideo: modalVideo
                });
                
                if (videoLoading) {
                    videoLoading.classList.add('d-none');
                    console.log('ğŸ¬ [DEBUG] ë¡œë”© í™”ë©´ ìˆ¨ê¹€ (ì¡°ê±´ ì‹¤íŒ¨)');
                }
                if (videoError) {
                    videoError.classList.remove('d-none');
                    console.log('ğŸ¬ [DEBUG] ì—ëŸ¬ í™”ë©´ í‘œì‹œ (ì¡°ê±´ ì‹¤íŒ¨)');
                    
                    const errorMessage = document.getElementById('error-message');
                    const errorUrl = document.getElementById('error-url');
                    if (errorMessage) {
                        errorMessage.textContent = videoUrl ? 'ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'ë¹„ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    if (errorUrl) {
                        errorUrl.textContent = videoUrl || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    }
                }
            }
            
            console.log('ğŸ¬ [DEBUG] í•¨ìˆ˜ ì‹¤í–‰ ì™„ë£Œ');
            
        } catch (error) {
            console.error('ğŸ¬ [DEBUG] âŒ ì˜ˆì™¸ ë°œìƒ:', error);
            console.error('ğŸ¬ [DEBUG] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
        }
    };

    // ===== ğŸ”„ ë¹„ë””ì˜¤ ì¬ì‹œë„ í•¨ìˆ˜ (ì¦‰ì‹œ ì •ì˜) =====
    window.retryVideo = function() {
        console.log('ğŸ”„ [DEBUG] ë¹„ë””ì˜¤ ì¬ì‹œë„ í•¨ìˆ˜ í˜¸ì¶œ');
        const modalVideo = document.getElementById('modal-video');
        console.log('ğŸ”„ [DEBUG] modalVideo ìš”ì†Œ:', modalVideo);
        if (modalVideo) {
            console.log('ğŸ”„ [DEBUG] modalVideo.load() í˜¸ì¶œ');
            modalVideo.load();
            console.log('ğŸ”„ [DEBUG] ì¬ì‹œë„ ì™„ë£Œ');
        } else {
            console.warn('ğŸ”„ [DEBUG] âš ï¸ ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    };

    // ===== ğŸ§¹ ëª¨ë‹¬ ë‹«í ë•Œ ì •ë¦¬ =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ§¹ [DEBUG] DOMContentLoaded ì´ë²¤íŠ¸ - ëª¨ë‹¬ ì •ë¦¬ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
        const videoModal = document.getElementById('video-modal');
        console.log('ğŸ§¹ [DEBUG] videoModal ìš”ì†Œ:', videoModal);
        if (videoModal) {
            videoModal.addEventListener('hidden.bs.modal', function() {
                console.log('ğŸ§¹ [DEBUG] ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ë°œìƒ');
                const modalVideo = document.getElementById('modal-video');
                if (modalVideo) {
                    modalVideo.pause();
                    modalVideo.currentTime = 0;
                    console.log('ğŸ§¹ [DEBUG] ğŸšª ëª¨ë‹¬ ë‹«í˜ - ë¹„ë””ì˜¤ ì •ë¦¬ ì™„ë£Œ');
                } else {
                    console.warn('ğŸ§¹ [DEBUG] âš ï¸ ì •ë¦¬í•  ë¹„ë””ì˜¤ ìš”ì†Œ ì—†ìŒ');
                }
            });
            console.log('ğŸ§¹ [DEBUG] ëª¨ë‹¬ ì •ë¦¬ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        } else {
            console.warn('ğŸ§¹ [DEBUG] âš ï¸ videoModal ìš”ì†Œ ì—†ìŒ - ì •ë¦¬ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹¤íŒ¨');
        }
    });
</script>