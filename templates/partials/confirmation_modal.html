<!-- ê²€ìƒ‰ í™•ì¸ ëª¨ë‹¬ -->
{% if show_confirmation %}
<div class="modal fade" id="search-confirmation-modal" tabindex="-1" aria-labelledby="search-confirmation-label" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-warning">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning" id="search-confirmation-label">
                    <i class="fas fa-exclamation-triangle me-2"></i>ê²€ìƒ‰ì–´ í™•ì¸
                </h5>
            </div>
            <div class="modal-body">
                <!-- ê²½ê³  ë©”ì‹œì§€ -->
                <div class="alert alert-warning border-warning bg-transparent" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle text-warning me-2 mt-1"></i>
                        <div>
                            <strong>{{ warning_message }}</strong>
                            
                            {% if warning_type == 'too_short' %}
                            <p class="mb-0 mt-2 small text-muted">
                                ì§§ì€ ê²€ìƒ‰ì–´ëŠ” ë„ˆë¬´ ë§ì€ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê³ , ì„œë²„ ë¶€í•˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            {% elif warning_type == 'single_char' %}
                            <p class="mb-0 mt-2 small text-muted">
                                ë‹¨ì¼ ë¬¸ì ê²€ìƒ‰ì€ ì˜ë¯¸ì—†ëŠ” ê²°ê³¼ê°€ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            {% elif warning_type == 'repeated_chars' %}
                            <p class="mb-0 mt-2 small text-muted">
                                ë°˜ë³µë˜ëŠ” ë¬¸ìëŠ” ì˜¤íƒ€ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
                            </p>
                            {% elif warning_type == 'mixed_languages' %}
                            <p class="mb-0 mt-2 small text-muted">
                                í•œê¸€ê³¼ ì˜ì–´ê°€ ì„ì¸ ê²€ìƒ‰ì–´ëŠ” ì •í™•í•œ ê²°ê³¼ë¥¼ ì°¾ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- í˜„ì¬ ì…ë ¥ -->
                <div class="mb-3">
                    <label class="form-label text-light small">í˜„ì¬ ì…ë ¥:</label>
                    <div class="bg-secondary bg-opacity-25 border border-secondary rounded p-2">
                        <code class="text-warning">"{{ original_input }}"</code>
                    </div>
                </div>

                <!-- ì œì•ˆ ì‚¬í•­ -->
                {% if suggestions %}
                <div class="mb-3">
                    <label class="form-label text-light small">ì œì•ˆí•˜ëŠ” ê²€ìƒ‰ì–´:</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for suggestion in suggestions %}
                        <button type="button" class="btn btn-outline-primary btn-sm suggestion-btn" 
                                data-suggestion="{{ suggestion }}"
                                onclick="selectSuggestion('{{ suggestion|escapejs }}')">
                            "{{ suggestion }}"
                        </button>
                        {% endfor %}
                    </div>
                    <small class="text-muted">ì œì•ˆëœ ê²€ìƒ‰ì–´ë¥¼ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤.</small>
                </div>
                {% endif %}

                <!-- ìˆ˜ì •ëœ ì…ë ¥ -->
                <div class="mb-3">
                    <label for="confirmed-input" class="form-label text-light small">
                        ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ (ìˆ˜ì • ê°€ëŠ¥):
                    </label>
                    <input type="text" 
                           id="confirmed-input" 
                           class="form-control bg-dark border-secondary text-white"
                           value="{{ original_input }}"
                           maxlength="500"
                           placeholder="ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           autofocus>
                    <div class="form-text text-muted">
                        í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•œ í›„ í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                    </div>
                </div>

                <!-- ë°ì´í„° í’ˆì§ˆ ì•ˆë‚´ -->
                <div class="bg-info bg-opacity-10 border border-info rounded p-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-lightbulb text-info me-2 mt-1"></i>
                        <div class="small">
                            <strong class="text-info">ë°ì´í„° í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ì•ˆë‚´</strong>
                            <p class="mb-0 mt-1 text-muted">
                                ì •í™•í•œ ê²€ìƒ‰ì–´ëŠ” ë” ë‚˜ì€ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì œê³µí•˜ê³ , 
                                ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì—ê²Œë„ ë„ì›€ì´ ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-warning">
                <button type="button" class="btn btn-secondary" onclick="cancelSearch()">
                    <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="proceedWithOriginal()">
                    <i class="fas fa-exclamation-triangle me-1"></i>ê·¸ëŒ€ë¡œ ê²€ìƒ‰
                </button>
                <button type="button" class="btn btn-primary" onclick="proceedWithConfirmed()">
                    <i class="fas fa-check me-1"></i>í™•ì¸ í›„ ê²€ìƒ‰
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ê²€ìƒ‰ í™•ì¸ ëª¨ë‹¬ ê´€ë ¨ JavaScript
function selectSuggestion(suggestion) {
    const confirmedInput = document.getElementById('confirmed-input');
    if (confirmedInput) {
        confirmedInput.value = suggestion;
        
        // ì„ íƒëœ ì œì•ˆ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary');
    }
}

function cancelSearch() {
    // ëª¨ë‹¬ ë‹«ê¸°
    const modal = bootstrap.Modal.getInstance(document.getElementById('search-confirmation-modal'));
    if (modal) {
        modal.hide();
    }
    
    // ê²€ìƒ‰ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
    const searchInput = document.getElementById('search-input-desktop') || document.getElementById('search-input-mobile');
    if (searchInput) {
        searchInput.focus();
    }
}

function proceedWithOriginal() {
    // ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰ ì§„í–‰
    const originalInput = '{{ original_input|escapejs }}';
    submitSearchWithText(originalInput);
}

function proceedWithConfirmed() {
    // í™•ì¸ëœ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰ ì§„í–‰
    const confirmedInput = document.getElementById('confirmed-input');
    if (!confirmedInput) return;
    
    const searchText = confirmedInput.value.trim();
    
    if (!searchText) {
        alert('ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        confirmedInput.focus();
        return;
    }
    
    submitSearchWithText(searchText);
}

function submitSearchWithText(searchText) {
    console.log('ğŸ”„ DEBUG: submitSearchWithText í˜¸ì¶œë¨:', searchText);
    
    // ğŸ¬ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ë¨¼ì € í‘œì‹œ (ëª¨ë‹¬ ë‹«ê¸° ì „ì—!)
    console.log('ğŸ¬ DEBUG: ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘');
    showSearchLoading();
    
    // ê²€ìƒ‰ í¼ì— í…ìŠ¤íŠ¸ ì„¤ì •
    const unifiedInput = document.getElementById('unified-search-input');
    const desktopInput = document.getElementById('search-input-desktop');
    const mobileInput = document.getElementById('search-input-mobile');
    
    if (unifiedInput) unifiedInput.value = searchText;
    if (desktopInput) desktopInput.value = searchText;
    if (mobileInput) mobileInput.value = searchText;
    
    // í™•ì¸ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ ì¶”ê°€
    const searchForm = document.getElementById('search-form');
    if (searchForm) {
        // ìˆ¨ê²¨ì§„ ì…ë ¥ ì¶”ê°€ (í™•ì¸ ê±´ë„ˆë›°ê¸°)
        let skipConfirm = document.getElementById('skip-confirmation');
        if (!skipConfirm) {
            skipConfirm = document.createElement('input');
            skipConfirm.type = 'hidden';
            skipConfirm.id = 'skip-confirmation';
            skipConfirm.name = 'skip_confirmation';
            searchForm.appendChild(skipConfirm);
        }
        skipConfirm.value = 'true';
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('search-confirmation-modal'));
        if (modal) {
            modal.hide();
        }
        
        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì´ í‘œì‹œëœ í›„ í¼ ì œì¶œ
        setTimeout(() => {
            console.log('ğŸš€ DEBUG: í¼ ì œì¶œ ì‹¤í–‰');
            searchForm.submit();
        }, 500); // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì´ í™•ì‹¤íˆ í‘œì‹œë˜ë„ë¡ 500ms ì§€ì—°
    }
}

// ğŸ¬ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ í•¨ìˆ˜
function showSearchLoading() {
    console.log('ğŸ¬ [LOADING] showSearchLoading í•¨ìˆ˜ í˜¸ì¶œë¨');
    
    const loadingOverlay = document.getElementById('search-loading-overlay');
    if (!loadingOverlay) {
        console.error('âŒ [LOADING] search-loading-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    loadingOverlay.classList.remove('d-none');
    console.log('âœ… [LOADING] ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œë¨');
    
    // ë¡œë”© ë‹¨ê³„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    startLoadingSteps();
}

// ğŸ¬ ë¡œë”© ë‹¨ê³„ ì• ë‹ˆë©”ì´ì…˜
function startLoadingSteps() {
    console.log('ğŸ¬ [LOADING] ë¡œë”© ë‹¨ê³„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘');
    
    const steps = ['step-search', 'step-fetch', 'step-process', 'step-save'];
    const progressBar = document.getElementById('search-progress');
    
    let currentStep = 0;
    
    function activateStep() {
        if (currentStep < steps.length) {
            const stepElement = document.getElementById(steps[currentStep]);
            if (stepElement) {
                stepElement.classList.add('active');
                console.log(`ğŸ¬ [LOADING] ë‹¨ê³„ í™œì„±í™”: ${steps[currentStep]}`);
            }
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            if (progressBar) {
                const progress = ((currentStep + 1) / steps.length) * 100;
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                console.log(`ğŸ“Š [LOADING] ì§„í–‰ë¥ : ${progress}%`);
            }
            
            currentStep++;
            
            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ (1ì´ˆ ê°„ê²©)
            if (currentStep < steps.length) {
                setTimeout(activateStep, 1000);
            }
        }
    }
    
    // ì²« ë²ˆì§¸ ë‹¨ê³„ ì‹œì‘
    activateStep();
}

// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œ ìë™ í‘œì‹œ
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¬ [MODAL] DOMContentLoaded - í™•ì¸ ëª¨ë‹¬ ì´ˆê¸°í™”');
    
    const modalElement = document.getElementById('search-confirmation-modal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('ğŸ¬ [MODAL] í™•ì¸ ëª¨ë‹¬ í‘œì‹œë¨');
        
        // Enter í‚¤ë¡œ í™•ì¸
        const confirmedInput = document.getElementById('confirmed-input');
        if (confirmedInput) {
            confirmedInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    proceedWithConfirmed();
                }
            });
        }
    }
});
</script>

<style>
/* ë¡œë”© ë‹¨ê³„ ìŠ¤íƒ€ì¼ */
.loading-steps {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.step.active {
    opacity: 1;
    transform: scale(1.1);
}

.step-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #6c757d;
    transition: color 0.3s ease;
}

.step.active .step-icon {
    color: #0d6efd;
}

.step-text {
    font-size: 0.875rem;
    color: #6c757d;
    transition: color 0.3s ease;
}

.step.active .step-text {
    color: #ffffff;
    font-weight: 500;
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
    .loading-steps {
        flex-direction: column;
        gap: 1rem;
    }
    
    .step {
        flex-direction: row;
        justify-content: center;
        gap: 1rem;
    }
}
</style>
{% endif %}